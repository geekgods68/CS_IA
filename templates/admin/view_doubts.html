{% extends 'admin/sidebar.html' %}
{% block content %}
<h2>Student Doubts & Questions</h2>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-question-circle"></i> All Student Doubts ({{ doubts_list|length }} total)</h5>
    </div>
    <div class="card-body">
        {% if doubts_list %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Question</th>
                        <th>Status</th>
                        <th>Posted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doubt in doubts_list %}
                    <tr>
                        <td>
                            <i class="bi bi-person"></i> {{ doubt[1] }}
                        </td>
                        <td>
                            {% if doubt[2] %}
                                <i class="bi bi-journal-bookmark"></i> {{ doubt[2] }}
                            {% else %}
                                <span class="text-muted">General</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if doubt[3] %}
                                <span class="badge bg-secondary">{{ doubt[3] }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 300px;" title="{{ doubt[4] }}">
                                {{ doubt[4] }}
                            </div>
                        </td>
                        <td>
                            {% if doubt[5] == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                            {% elif doubt[5] == 'answered' %}
                                <span class="badge bg-success">Answered</span>
                            {% else %}
                                <span class="badge bg-info">{{ doubt[5] }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ doubt[6].strftime('%Y-%m-%d %H:%M') if doubt[6] else 'N/A' }}</small>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-info" 
                                    onclick="viewDoubtDetails({{ doubt[0] }}, '{{ doubt[4]|tojson }}', '{{ doubt[7]|tojson if doubt[7] else '' }}', '{{ doubt[5] }}')">
                                <i class="bi bi-eye"></i> View
                            </button>
                            {% if doubt[5] == 'pending' %}
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="respondToDoubt({{ doubt[0] }})">
                                <i class="bi bi-reply"></i> Respond
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-question-circle display-4 text-muted"></i>
            <p class="text-muted mt-2">No student doubts found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Doubt Details Modal -->
<div class="modal fade" id="doubtDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-question-circle"></i> Doubt Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Question:</label>
                    <div id="doubtQuestion" class="border p-3 bg-light rounded"></div>
                </div>
                <div id="doubtResponseSection" class="mb-3" style="display: none;">
                    <label class="fw-bold">Admin Response:</label>
                    <div id="doubtResponse" class="border p-3 bg-success bg-opacity-10 rounded"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal fade" id="respondModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.respond_doubt') }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-reply"></i> Respond to Doubt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="responseDoubtId" name="doubt_id">
                    <div class="mb-3">
                        <label for="response" class="form-label">Your Response</label>
                        <textarea id="response" name="response" class="form-control" rows="4" 
                                placeholder="Provide a helpful response to the student's question..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Send Response
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function viewDoubtDetails(doubtId, question, response, status) {
    document.getElementById('doubtQuestion').textContent = question;
    
    const responseSection = document.getElementById('doubtResponseSection');
    const responseDiv = document.getElementById('doubtResponse');
    
    if (response && status === 'answered') {
        responseDiv.textContent = response;
        responseSection.style.display = 'block';
    } else {
        responseSection.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('doubtDetailsModal')).show();
}

function respondToDoubt(doubtId) {
    document.getElementById('responseDoubtId').value = doubtId;
    document.getElementById('response').value = '';
    new bootstrap.Modal(document.getElementById('respondModal')).show();
}

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add status filter
    const cardHeader = document.querySelector('.card-header h5');
    const filterContainer = document.createElement('div');
    filterContainer.className = 'mt-2';
    filterContainer.innerHTML = `
        <select id="statusFilter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="answered">Answered</option>
        </select>
    `;
    cardHeader.parentNode.appendChild(filterContainer);
    
    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', function() {
        const filterValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const statusBadge = row.querySelector('td:nth-child(5) .badge');
            const status = statusBadge ? statusBadge.textContent.toLowerCase() : '';
            
            if (filterValue === '' || status.includes(filterValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
