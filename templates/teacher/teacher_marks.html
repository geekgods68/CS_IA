<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marks & Reports - Teacher Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .table th {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .nav-tabs .nav-link.active {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .nav-tabs .nav-link {
            color: #28a745;
        }
        .nav-tabs .nav-link:hover {
            border-color: #28a745;
            color: #1e7e34;
        }
        .assessment-card {
            border-left: 4px solid #28a745;
        }
        .score-input {
            width: 80px;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .alert-dismissible .btn-close {
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('teacher.dashboard') }}">
                <i class="bi bi-person-workspace"></i> Teacher Portal
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('teacher.dashboard') }}">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-graph-up"></i> Marks & Reports</h4>
                        <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-outline-light">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                    <div class="card-body">
                        <!-- Navigation Tabs -->
                        <ul class="nav nav-tabs" id="marksTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="assessments-tab" data-bs-toggle="tab" data-bs-target="#assessments" type="button" role="tab">
                                    <i class="bi bi-file-earmark-text"></i> Assessments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="marks-tab" data-bs-toggle="tab" data-bs-target="#marks" type="button" role="tab">
                                    <i class="bi bi-pencil-square"></i> Enter Marks
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                                    <i class="bi bi-bar-chart"></i> Reports
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="marksTabContent">
                            <!-- Assessments Tab -->
                            <div class="tab-pane fade show active" id="assessments" role="tabpanel">
                                <div class="row mt-4">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5><i class="bi bi-plus-circle"></i> Create Assessment</h5>
                                            </div>
                                            <div class="card-body">
                                                <form method="POST" action="{{ url_for('teacher.create_assessment') }}">
                                                    <div class="mb-3">
                                                        <label for="class_id" class="form-label">Class *</label>
                                                        <select class="form-select" id="class_id" name="class_id" required>
                                                            <option value="">Select a class</option>
                                                            {% for class in assigned_classes %}
                                                                <option value="{{ class[0] }}">{{ class[1] }} (Grade {{ class[2] }})</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="subject_name" class="form-label">Subject *</label>
                                                        <select class="form-select" id="subject_name" name="subject_name" required>
                                                            <option value="">Select a subject</option>
                                                            {% for subject in teacher_subjects %}
                                                                <option value="{{ subject[0] }}">{{ subject[0] }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="title" class="form-label">Assessment Title *</label>
                                                        <input type="text" class="form-control" id="title" name="title" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="description" class="form-label">Description</label>
                                                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="assessment_date" class="form-label">Assessment Date *</label>
                                                        <input type="date" class="form-control" id="assessment_date" name="assessment_date" required>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <label for="max_score" class="form-label">Max Score *</label>
                                                            <input type="number" class="form-control" id="max_score" name="max_score" step="0.1" min="0.1" required>
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="weight" class="form-label">Weight</label>
                                                            <input type="number" class="form-control" id="weight" name="weight" step="0.1" min="0" max="1" value="1.0">
                                                        </div>
                                                    </div>
                                                    <button type="submit" class="btn btn-success mt-3 w-100">
                                                        <i class="bi bi-plus"></i> Create Assessment
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5><i class="bi bi-list-ul"></i> My Assessments</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <select class="form-select" id="filter_class">
                                                            <option value="">All Classes</option>
                                                            {% for class in assigned_classes %}
                                                                <option value="{{ class[0] }}">{{ class[1] }} (Grade {{ class[2] }})</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <select class="form-select" id="filter_subject">
                                                            <option value="">All Subjects</option>
                                                            {% for subject in teacher_subjects %}
                                                                <option value="{{ subject[0] }}">{{ subject[0] }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="assessments_list">
                                                    <p class="text-muted">Select a class and subject to view assessments.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enter Marks Tab -->
                            <div class="tab-pane fade" id="marks" role="tabpanel">
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5><i class="bi bi-pencil-square"></i> Enter Student Marks</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">Class</label>
                                                        <select class="form-select" id="marks_class_id">
                                                            <option value="">Select a class</option>
                                                            {% for class in assigned_classes %}
                                                                <option value="{{ class[0] }}">{{ class[1] }} (Grade {{ class[2] }})</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Subject</label>
                                                        <select class="form-select" id="marks_subject_name">
                                                            <option value="">Select a subject</option>
                                                            {% for subject in teacher_subjects %}
                                                                <option value="{{ subject[0] }}">{{ subject[0] }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Assessment</label>
                                                        <select class="form-select" id="marks_assessment_id">
                                                            <option value="">Select an assessment</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="marks_roster" class="mt-4">
                                                    <p class="text-muted">Select a class, subject, and assessment to enter marks.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports Tab -->
                            <div class="tab-pane fade" id="reports" role="tabpanel">
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5><i class="bi bi-bar-chart"></i> Generate Reports</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-4">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Class</label>
                                                        <select class="form-select" id="reports_class_id">
                                                            <option value="">Select a class</option>
                                                            {% for class in assigned_classes %}
                                                                <option value="{{ class[0] }}">{{ class[1] }} (Grade {{ class[2] }})</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Subject</label>
                                                        <select class="form-select" id="reports_subject_name">
                                                            <option value="">Select a subject</option>
                                                            {% for subject in teacher_subjects %}
                                                                <option value="{{ subject[0] }}">{{ subject[0] }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">From Date</label>
                                                        <input type="date" class="form-control" id="reports_from_date">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">To Date</label>
                                                        <input type="date" class="form-control" id="reports_to_date">
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <button type="button" class="btn btn-success" id="generate_class_report">
                                                            <i class="bi bi-file-earmark-bar-graph"></i> Generate Class Report
                                                        </button>
                                                        <button type="button" class="btn btn-outline-success ms-2" id="export_assessment_csv">
                                                            <i class="bi bi-download"></i> Export Assessment CSV
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="reports_content">
                                                    <p class="text-muted">Select filters and click "Generate Class Report" to view performance statistics.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentAssessmentId = null;
        let currentMaxScore = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default assessment date to today
            document.getElementById('assessment_date').value = new Date().toISOString().split('T')[0];
            
            // Event listeners for filters
            document.getElementById('filter_class').addEventListener('change', loadAssessments);
            document.getElementById('filter_subject').addEventListener('change', loadAssessments);
            
            // Event listeners for marks entry
            document.getElementById('marks_class_id').addEventListener('change', loadMarksAssessments);
            document.getElementById('marks_subject_name').addEventListener('change', loadMarksAssessments);
            document.getElementById('marks_assessment_id').addEventListener('change', loadMarksRoster);
            
            // Event listeners for reports
            document.getElementById('generate_class_report').addEventListener('click', generateClassReport);
            document.getElementById('export_assessment_csv').addEventListener('click', exportAssessmentCSV);
        });

        // Load assessments based on filters
        function loadAssessments() {
            const classId = document.getElementById('filter_class').value;
            const subjectName = document.getElementById('filter_subject').value;
            
            if (!classId || !subjectName) {
                document.getElementById('assessments_list').innerHTML = '<p class="text-muted">Select a class and subject to view assessments.</p>';
                return;
            }
            
            document.getElementById('assessments_list').innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div></div>';
            
            fetch(`/teacher/assessments/list?class_id=${classId}&subject_name=${encodeURIComponent(subjectName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('assessments_list').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    if (data.length === 0) {
                        document.getElementById('assessments_list').innerHTML = '<p class="text-muted">No assessments found for the selected class and subject.</p>';
                        return;
                    }
                    
                    let html = '';
                    data.forEach(assessment => {
                        html += `
                            <div class="card assessment-card mb-3">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="card-title mb-1">${assessment.title}</h6>
                                            <p class="card-text mb-1">
                                                <small class="text-muted">
                                                    Date: ${assessment.date} | Max Score: ${assessment.max_score} | Weight: ${assessment.weight}
                                                </small>
                                            </p>
                                            ${assessment.description ? `<p class="card-text mb-0">${assessment.description}</p>` : ''}
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <form method="POST" action="{{ url_for('teacher.delete_assessment') }}" style="display: inline;">
                                                <input type="hidden" name="assessment_id" value="${assessment.id}">
                                                <button type="submit" class="btn btn-danger btn-sm" 
                                                        onclick="return confirm('Are you sure you want to delete this assessment? All marks will be lost.')">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('assessments_list').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('assessments_list').innerHTML = `<div class="alert alert-danger">Error loading assessments: ${error.message}</div>`;
                });
        }

        // Load assessments for marks entry
        function loadMarksAssessments() {
            const classId = document.getElementById('marks_class_id').value;
            const subjectName = document.getElementById('marks_subject_name').value;
            const assessmentSelect = document.getElementById('marks_assessment_id');
            
            assessmentSelect.innerHTML = '<option value="">Select an assessment</option>';
            document.getElementById('marks_roster').innerHTML = '<p class="text-muted">Select a class, subject, and assessment to enter marks.</p>';
            
            if (!classId || !subjectName) return;
            
            fetch(`/teacher/assessments/list?class_id=${classId}&subject_name=${encodeURIComponent(subjectName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        assessmentSelect.innerHTML = '<option value="">Error loading assessments</option>';
                        return;
                    }
                    
                    data.forEach(assessment => {
                        const option = document.createElement('option');
                        option.value = assessment.id;
                        option.textContent = `${assessment.title} (${assessment.date})`;
                        assessmentSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    assessmentSelect.innerHTML = '<option value="">Error loading assessments</option>';
                });
        }

        // Load student roster for marks entry
        function loadMarksRoster() {
            const classId = document.getElementById('marks_class_id').value;
            const assessmentId = document.getElementById('marks_assessment_id').value;
            
            if (!classId || !assessmentId) {
                document.getElementById('marks_roster').innerHTML = '<p class="text-muted">Select a class, subject, and assessment to enter marks.</p>';
                return;
            }
            
            currentAssessmentId = assessmentId;
            document.getElementById('marks_roster').innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div></div>';
            
            fetch(`/teacher/marks/roster?class_id=${classId}&assessment_id=${assessmentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('marks_roster').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    currentMaxScore = data.max_score;
                    
                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Student Marks (Max Score: ${data.max_score})</h6>
                            <button type="button" class="btn btn-success" onclick="saveAllMarks()">
                                <i class="bi bi-save"></i> Save All Marks
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Score</th>
                                        <th>Comment</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.students.forEach(student => {
                        html += `
                            <tr>
                                <td>${student.name}</td>
                                <td>
                                    <input type="number" 
                                           class="form-control score-input" 
                                           data-student-id="${student.id}"
                                           value="${student.score}" 
                                           min="0" 
                                           max="${data.max_score}"
                                           step="0.1">
                                </td>
                                <td>
                                    <input type="text" 
                                           class="form-control comment-input" 
                                           data-student-id="${student.id}"
                                           value="${student.comment}" 
                                           placeholder="Optional comment">
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('marks_roster').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('marks_roster').innerHTML = `<div class="alert alert-danger">Error loading roster: ${error.message}</div>`;
                });
        }

        // Save all marks
        function saveAllMarks() {
            if (!currentAssessmentId) {
                alert('No assessment selected');
                return;
            }
            
            const items = [];
            const scoreInputs = document.querySelectorAll('.score-input');
            const commentInputs = document.querySelectorAll('.comment-input');
            
            scoreInputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const score = input.value.trim();
                const commentInput = document.querySelector(`.comment-input[data-student-id="${studentId}"]`);
                const comment = commentInput ? commentInput.value.trim() : '';
                
                if (score !== '') {
                    if (parseFloat(score) > currentMaxScore) {
                        alert(`Score ${score} exceeds maximum score ${currentMaxScore} for student ID ${studentId}`);
                        return;
                    }
                    items.push({
                        student_id: studentId,
                        score: score,
                        comment: comment
                    });
                }
            });
            
            if (items.length === 0) {
                alert('No marks to save');
                return;
            }
            
            // Show loading state
            document.getElementById('marks_roster').classList.add('loading');
            
            fetch('/teacher/marks/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assessment_id: currentAssessmentId,
                    items: items
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('marks_roster').classList.remove('loading');
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                let message = `Marks saved successfully!\n`;
                message += `Saved: ${data.saved}, Updated: ${data.updated}, Skipped: ${data.skipped}`;
                
                if (data.errors && data.errors.length > 0) {
                    message += `\n\nErrors:\n${data.errors.join('\n')}`;
                }
                
                alert(message);
            })
            .catch(error => {
                document.getElementById('marks_roster').classList.remove('loading');
                alert(`Error saving marks: ${error.message}`);
            });
        }

        // Generate class report
        function generateClassReport() {
            const classId = document.getElementById('reports_class_id').value;
            const subjectName = document.getElementById('reports_subject_name').value;
            const fromDate = document.getElementById('reports_from_date').value;
            const toDate = document.getElementById('reports_to_date').value;
            
            if (!classId || !subjectName) {
                alert('Please select a class and subject');
                return;
            }
            
            let url = `/teacher/reports/class?class_id=${classId}&subject_name=${encodeURIComponent(subjectName)}`;
            if (fromDate) url += `&from=${fromDate}`;
            if (toDate) url += `&to=${toDate}`;
            
            window.open(url, '_blank');
        }

        // Export assessment CSV
        function exportAssessmentCSV() {
            const assessmentId = document.getElementById('marks_assessment_id').value;
            
            if (!assessmentId) {
                alert('Please select an assessment in the Enter Marks tab');
                return;
            }
            
            window.location.href = `/teacher/reports/export_csv?assessment_id=${assessmentId}`;
        }
    </script>
</body>
</html>
